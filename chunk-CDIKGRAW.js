import{a as ee}from"./chunk-TW5C6UBZ.js";import{a as Z,b as x}from"./chunk-SWMJ6OPV.js";import{b as A}from"./chunk-ZLIFJTJT.js";import{c as B}from"./chunk-NV6E2ESI.js";import{S as N}from"./chunk-D5LX53AO.js";import{g as y,k as D}from"./chunk-7XFTMEP4.js";import{$b as Y,Bc as k,Fb as M,Gb as i,Hb as a,Ib as S,Wb as Q,Ya as H,Za as m,ac as U,bc as G,ca as F,ha as b,jc as o,kc as g,l as T,lc as X,mc as J,ob as v,p as $,tb as O,xa as P}from"./chunk-KF4UV7BN.js";import"./chunk-FDERIQAA.js";var z=class r{ONE_DAY=1e3*60*60*24;diasEntre(t,e){return Math.round((t-e)/this.ONE_DAY)}calcularIntervalos(t){if(t.length<2)return{media:0,min:0,max:0};let e=t.slice(1).map((n,l)=>this.diasEntre(n,t[l]));return{media:Math.round(e.reduce((n,l)=>n+l,0)/e.length),min:Math.min(...e),max:Math.max(...e)}}calcularTrocaStats(t,e,n){let l=n==="REFIL"?"trocaRefil":"trocaAtrativo",p=new Map;t.forEach(f=>{if(f[l]){let u=new Date(f.data).getTime();p.has(f.armadilhaId)||p.set(f.armadilhaId,[]),p.get(f.armadilhaId).push(u)}});let s=[],d=0,h=0,R=Date.now();return e.forEach(f=>{let u=p.get(f.id);if(!u||u.length===0){h++;return}u.sort((c,_)=>c-_);let E=this.calcularIntervalos(u);E.max>0&&s.push(E.max);let w=u[u.length-1],W=this.diasEntre(R,w);d=Math.max(d,W)}),{tipo:n,mediaDias:s.length?Math.round(s.reduce((f,u)=>f+u,0)/s.length):0,menorIntervalo:s.length?Math.min(...s):0,maiorIntervalo:s.length?Math.max(...s):0,armadilhasSemTroca:h,maiorPeriodoAtual:d}}calcularRankingCritico(t,e){let n=Date.now(),l=1e3*60*60*24,p=new Map;return t.forEach(s=>{p.has(s.armadilhaId)||p.set(s.armadilhaId,[]),p.get(s.armadilhaId).push(s)}),e.map(s=>{let d=p.get(s.id)??[],h=d.filter(c=>c.trocaRefil).map(c=>new Date(c.data).getTime()).sort((c,_)=>_-c)[0],R=d.filter(c=>c.trocaAtrativo).map(c=>new Date(c.data).getTime()).sort((c,_)=>_-c)[0],f=h?Math.round((n-h)/l):null,u=R?Math.round((n-R)/l):null,E=d.filter(c=>c.situacaoFisica==="EXTRAVIADA").length,w=d.filter(c=>c.situacaoFisica==="DERRUBADA").length,W=(f??0)*1.2+(u??0)*1+E*30+w*20;return{armadilhaId:s.id,nome:s.nome,regiao:s.regiao,diasSemRefil:f,diasSemAtrativo:u,qtdExtravios:E,qtdDerrubadas:w,scoreCriticidade:Math.round(W)}}).sort((s,d)=>d.scoreCriticidade-s.scoreCriticidade)}calcularIntervalosTroca(t,e){let n=e==="REFIL"?"trocaRefil":"trocaAtrativo",l=t.filter(d=>d[n]).map(d=>new Date(d.data).getTime()).sort((d,h)=>d-h);if(l.length<2)return{tipo:e,intervalos:[],media:0,min:0,max:0};let p=1e3*60*60*24,s=l.slice(1).map((d,h)=>Math.round((d-l[h])/p));return{tipo:e,intervalos:s,media:Math.round(s.reduce((d,h)=>d+h,0)/s.length),min:Math.min(...s),max:Math.max(...s)}}buildTimeSeries(t){let e=new Map;return t.forEach(n=>{let l=new Date(n.data).getTime(),p=n.trocaRefil||n.trocaAtrativo,s=n.situacaoFisica==="REGULAR";if(!s&&!p)return;e.has(l)||e.set(l,{timestamp:l,numAedes:0,numCulex:0,numOutras:0,numTotal:0});let d=e.get(l);s&&(d.numAedes+=n.numAedes,d.numCulex+=n.numCulex,d.numOutras+=n.numOutras,d.numTotal+=n.numTotal)}),Array.from(e.values()).sort((n,l)=>n.timestamp-l.timestamp)}static \u0275fac=function(e){return new(e||r)};static \u0275prov=F({token:r,factory:r.\u0275fac,providedIn:"root"})};var C=class r{metrics=b(z);getTimeSeries(){return T(this.metrics.buildTimeSeries(x))}getKpis(){let t=A.length,e=x.length,n=x.reduce((l,p)=>l+p.numTotal,0);return T([{id:"armadilhas",label:"Armadilhas",value:t},{id:"capturas",label:"Capturas",value:e},{id:"mosquitos",label:"Mosquitos",value:n}])}getTrocaStats(){return T([this.metrics.calcularTrocaStats(x,A,"REFIL"),this.metrics.calcularTrocaStats(x,A,"ATRATIVO")])}getOperationalKpis(){return this.getTrocaStats().pipe($(t=>t.flatMap(e=>[{id:`media-${e.tipo}`,label:`M\xE9dia entre trocas (${e.tipo.toLowerCase()})`,value:e.mediaDias,unit:"dias"},{id:`maior-${e.tipo}`,label:`Maior per\xEDodo sem troca (${e.tipo.toLowerCase()})`,value:e.maiorPeriodoAtual,unit:"dias"}])))}getRankingCritico(){return T(this.metrics.calcularRankingCritico(x,A))}getIntervalosTroca(){let t=this.metrics.calcularIntervalosTroca(x,"REFIL"),e=this.metrics.calcularIntervalosTroca(x,"ATRATIVO");return T([t,e])}static \u0275fac=function(e){return new(e||r)};static \u0275prov=F({token:r,factory:r.\u0275fac,providedIn:"root"})};function ne(r,t){if(r&1&&(i(0,"div",2)(1,"div",3),o(2),a(),i(3,"div",4),o(4),a()()),r&2){let e=t.$implicit;m(2),g(e.label),m(2),J("",e.value," ",e.unit)}}var K=class r{dataService=b(C);kpis=N(this.dataService.getKpis(),{initialValue:[]});static \u0275fac=function(e){return new(e||r)};static \u0275cmp=v({type:r,selectors:[["app-kpi-cards"]],decls:2,vars:1,consts:[[1,"kpi-grid"],["class","kpi-card",4,"ngFor","ngForOf"],[1,"kpi-card"],[1,"kpi-label"],[1,"kpi-value"]],template:function(e,n){e&1&&(i(0,"div",0),O(1,ne,5,3,"div",1),a()),e&2&&(m(),M("ngForOf",n.kpis()))},dependencies:[D,y],styles:[".kpi-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}.kpi-card[_ngcontent-%COMP%]{padding:12px 16px;border-left:4px solid #374151}.kpi-label[_ngcontent-%COMP%]{font-size:12px;color:#6b7280}.kpi-value[_ngcontent-%COMP%]{font-size:20px;font-weight:600}"]})};var j=class r{chart;onResize(){this.chart?.chart?.resize()}ngAfterViewInit(){setTimeout(()=>{this.chart?.chart?.resize()},0)}dataService=b(C);data=N(this.dataService.getTimeSeries(),{initialValue:[]});chartData=k(()=>{let t=this.data();return{datasets:[{label:"Total",data:t.map(e=>({x:e.timestamp,y:e.numTotal})),borderColor:"#d32f2f",backgroundColor:"rgba(211, 47, 47, 0.5)",borderWidth:2,tension:.3,pointRadius:2},{label:"Aedes",data:t.map(e=>({x:e.timestamp,y:e.numAedes})),borderColor:"#1e88e5",backgroundColor:"rgba(30, 136, 229, 0.5)",tension:.3,borderWidth:1,pointRadius:2},{label:"Culex",data:t.map(e=>({x:e.timestamp,y:e.numCulex})),borderColor:"#8e24aa",backgroundColor:"rgba(141, 36, 170, 0.5)",tension:.3,borderWidth:1,pointRadius:2},{label:"Outras",data:t.map(e=>({x:e.timestamp,y:e.numOutras})),borderColor:"#546e7a",backgroundColor:"rgba(84, 110, 122, 0.5)",tension:.3,borderWidth:1,pointRadius:2}]}});chartOptions={responsive:!0,maintainAspectRatio:!1,resizeDelay:100,interaction:{mode:"nearest",intersect:!1},plugins:{legend:{position:"bottom",labels:{boxWidth:12,padding:16,usePointStyle:!0,font:{size:12}}},annotation:{annotations:Object.fromEntries(Z.map(t=>[t.id,{type:"line",xMin:new Date(t.data).getTime(),xMax:new Date(t.data).getTime(),borderColor:"#2e7d32",borderWidth:2,borderDash:[4,4],label:{display:!0,content:"Aplica\xE7\xE3o",position:"end",rotation:270,backgroundColor:"rgba(255, 255, 255, 1)",color:"#2e7d32",borderWidth:.5,borderColor:"#2e7d32",borderRadius:6,font:{size:12},padding:5}}]))}},scales:{x:{type:"time",adapters:{date:{locale:ee}},time:{unit:"month",displayFormats:{month:"MMM yyyy"}},ticks:{autoSkip:!0,maxTicksLimit:6,font:{size:11}},grid:{color:"rgba(0,0,0,0.05)"}},y:{ticks:{font:{size:11}},grid:{color:"rgba(0,0,0,0.08)"}}}};static \u0275fac=function(e){return new(e||r)};static \u0275cmp=v({type:r,selectors:[["app-time-series-chart"]],viewQuery:function(e,n){if(e&1&&Y(B,5),e&2){let l;U(l=G())&&(n.chart=l.first)}},hostBindings:function(e,n){e&1&&Q("resize",function(){return n.onResize()},H)},decls:1,vars:3,consts:[["baseChart","",3,"type","data","options"]],template:function(e,n){e&1&&S(0,"canvas",0),e&2&&M("type","line")("data",n.chartData())("options",n.chartOptions)},dependencies:[B],encapsulation:2})};function ie(r,t){if(r&1&&(i(0,"tr")(1,"td",3),o(2),a(),i(3,"td",4),o(4),a(),i(5,"td",4),o(6),a(),i(7,"td",4),o(8),a(),i(9,"td",4),o(10),a(),i(11,"td",5),o(12),a()()),r&2){let e=t.$implicit;m(2),g(e.nome),m(2),g(e.diasSemRefil??"-"),m(2),g(e.diasSemAtrativo??"-"),m(2),g(e.qtdExtravios),m(2),g(e.qtdDerrubadas),m(2),g(e.scoreCriticidade)}}var V=class r{dataService=b(C);rankingSource=P([]);topN=P(10);constructor(){this.loadRanking()}ranking=k(()=>[...this.rankingSource()].sort((t,e)=>e.scoreCriticidade-t.scoreCriticidade).slice(0,this.topN()));loadRanking(){this.dataService.getRankingCritico().subscribe({next:t=>this.rankingSource.set(t),error:t=>console.error("Erro ao carregar ranking cr\xEDtico",t)})}onSelectTrap(t){console.log("Armadilha selecionada:",t.armadilhaId)}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=v({type:r,selectors:[["app-ranking-table"]],decls:17,vars:1,consts:[[1,"ranking-table"],[1,"score-col"],[4,"ngFor","ngForOf"],[1,"name"],[1,"num"],[1,"score"]],template:function(e,n){e&1&&(i(0,"table",0)(1,"thead")(2,"tr")(3,"th"),o(4,"Armadilha"),a(),i(5,"th"),o(6,"Dias sem refil"),a(),i(7,"th"),o(8,"Dias sem atrativo"),a(),i(9,"th"),o(10,"Extravios"),a(),i(11,"th"),o(12,"Derrubadas"),a(),i(13,"th",1),o(14,"Score"),a()()(),i(15,"tbody"),O(16,ie,13,6,"tr",2),a()()),e&2&&(m(16),M("ngForOf",n.ranking()))},dependencies:[D,y],styles:[".ranking-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;font-size:13px}.ranking-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{text-align:left;font-weight:600;padding:8px;border-bottom:1px solid #e5e7eb;color:#374151}.ranking-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:6px 8px;border-bottom:1px solid #f1f5f9}.ranking-table[_ngcontent-%COMP%]   .num[_ngcontent-%COMP%]{text-align:right;font-variant-numeric:tabular-nums}.ranking-table[_ngcontent-%COMP%]   .name[_ngcontent-%COMP%]{font-weight:500}.ranking-table[_ngcontent-%COMP%]   .score-col[_ngcontent-%COMP%], .ranking-table[_ngcontent-%COMP%]   .score[_ngcontent-%COMP%]{text-align:right}.ranking-table[_ngcontent-%COMP%]   .score[_ngcontent-%COMP%]{font-weight:600;font-family:monospace}"]})};function oe(r,t){if(r&1&&(i(0,"div",2)(1,"div",3)(2,"span",4),o(3),a()(),i(4,"div",5)(5,"div",6)(6,"span",7),o(7,"M\xE9dia"),a(),i(8,"span",8),o(9),a(),i(10,"span",9),o(11,"dias"),a()(),i(12,"div",6)(13,"span",7),o(14,"Menor"),a(),i(15,"span",8),o(16),a(),i(17,"span",9),o(18,"dias"),a()(),i(19,"div",6)(20,"span",7),o(21,"Maior"),a(),i(22,"span",8),o(23),a(),i(24,"span",9),o(25,"dias"),a()()()()),r&2){let e=t.$implicit;m(3),X(" ",e.tipo==="REFIL"?"Troca de refil":"Troca de atrativo"," "),m(6),g(e.media),m(7),g(e.min),m(7),g(e.max)}}var q=class r{dataService=b(C);source=P([]);constructor(){this.load()}stats=k(()=>this.source().sort((t,e)=>t.tipo.localeCompare(e.tipo)));load(){this.dataService.getIntervalosTroca().subscribe({next:t=>this.source.set(t),error:t=>console.error("Erro ao carregar intervalos de troca",t)})}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=v({type:r,selectors:[["app-interval-stats"]],decls:2,vars:1,consts:[[1,"interval-stats"],["class","interval-card",4,"ngFor","ngForOf"],[1,"interval-card"],[1,"interval-header"],[1,"interval-title"],[1,"interval-metrics"],[1,"metric"],[1,"label"],[1,"value"],[1,"unit"]],template:function(e,n){e&1&&(i(0,"div",0),O(1,oe,26,4,"div",1),a()),e&2&&(m(),M("ngForOf",n.stats()))},dependencies:[D,y],styles:[".interval-stats[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr;gap:16px}.interval-card[_ngcontent-%COMP%]{padding:12px 16px;border:1px solid #e5e7eb;border-radius:6px;background:#fff}.interval-header[_ngcontent-%COMP%]{margin-bottom:8px}.interval-title[_ngcontent-%COMP%]{font-size:13px;font-weight:600;color:#1f2937}.interval-metrics[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}.metric[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:flex-start}.metric[_ngcontent-%COMP%]   .label[_ngcontent-%COMP%]{font-size:11px;color:#6b7280}.metric[_ngcontent-%COMP%]   .value[_ngcontent-%COMP%]{font-size:18px;font-weight:600;line-height:1.1}.metric[_ngcontent-%COMP%]   .unit[_ngcontent-%COMP%]{font-size:11px;color:#6b7280}@media (max-width: 480px){.interval-metrics[_ngcontent-%COMP%]{grid-template-columns:1fr;gap:8px}}"]})};var ae=class r{static \u0275fac=function(e){return new(e||r)};static \u0275cmp=v({type:r,selectors:[["app-dashboard-component"]],decls:21,vars:0,consts:[[1,"dashboard"],[1,"dashboard-section","kpis"],[1,"dashboard-section","timeseries"],[1,"chart-container"],[1,"dashboard-section","analytics"],[1,"analytics-block"],[1,"section-header"],[1,"section-subtitle"]],template:function(e,n){e&1&&(i(0,"section",0)(1,"header",1),S(2,"app-kpi-cards"),a(),i(3,"section",2)(4,"div",3),S(5,"app-time-series-chart"),a()(),i(6,"section",4)(7,"div",5)(8,"div",6)(9,"h3"),o(10,"Intervalos de troca"),a(),i(11,"span",7),o(12," An\xE1lise de regularidade operacional "),a()(),S(13,"app-interval-stats"),a(),i(14,"div",5)(15,"div",6)(16,"h3"),o(17,"Armadilhas cr\xEDticas"),a(),i(18,"span",7),o(19," Prioridade operacional "),a()(),S(20,"app-ranking-table"),a()()())},dependencies:[D,K,j,V,q],styles:[".dashboard[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:24px;padding:24px;background-color:#f6f7f9}.dashboard-section[_ngcontent-%COMP%]{background:#fff;border-radius:6px;padding:16px 20px;box-shadow:0 1px 2px #0000000f}.dashboard-section.kpis[_ngcontent-%COMP%]{padding:12px 16px}.dashboard-section.timeseries[_ngcontent-%COMP%]{min-height:360px}.chart-container[_ngcontent-%COMP%]{position:relative;width:100%;height:420px}.dashboard-section.analytics[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:24px}.section-header[_ngcontent-%COMP%]{margin-bottom:12px}.section-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%], .section-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:16px;font-weight:600;color:#1f2937}.section-subtitle[_ngcontent-%COMP%]{font-size:12px;color:#6b7280}.analytics-block[_ngcontent-%COMP%]{display:flex;flex-direction:column}"]})};export{ae as DashboardComponent};
